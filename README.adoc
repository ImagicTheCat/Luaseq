= Luaseq
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:toc: left
:toclevels: 5

Luaseq is an asynchronous helper library built on coroutines. It can be used to perform asynchronous tasks in a "sequential" way.

== Install

See link:src[], link:rockspecs[] or https://luarocks.org/modules/imagicthecat-0a6b669a3a/luaseq[luarocks].

== Concept

A task can be created and then waited for completion from multiple coroutines. This can be used to design complex asynchronous dependencies.

NOTE: Coroutine resume errors are written on `stderr` prefixed by `async: ...`.

== API

[source,lua]
----
-- Async utility.
--
-- No arguments: create a task.
--- return task
--
-- With arguments: execute a function as a coroutine (directly resumed).
-- Note: this does nothing special, any coroutine can be used with tasks.
--
--- f: function
--- return created coroutine (thread)
Luaseq.async(f)

-- Task

-- Wait for task completion.
-- Will yield the current coroutine if the task is not completed.
--
-- return task return values
task:wait()

-- Complete task (subsequent calls will throw an error).
-- Waiting coroutines are resumed in the same order of wait() calls.
--
-- ...: task return values
task(...)

-- A task is a table where the array part is the list of waiting coroutines.
-- When completed, two fields are added:
task.r -- list of return values
task.n -- number of return values
----

.Basic usage
====
If we have an asynchronous process, like fetching an URL:

[source,lua]
----
local Luaseq = require("Luaseq")
async = Luaseq.async

-- Create the async download function.
function download(url)
  local r = async() -- create task
  http_request(url, function(content) -- useless outer callback for the sake of clarity
    r(content) -- complete task, return content
  end)
  return r:wait() -- wait for the returned values
end

-- Download 10 URLs sequentially (need to be inside a coroutine).
async(function()
  for i=1,10 do
    local content = download("http://foo.bar/"..i..".txt")
    print(content)
  end
end)
----
====
